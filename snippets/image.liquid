{% doc %}
  Renders a responsive image that might be wrapped in a link with lazy loading support.

  When `width`, `height` and `crop` are provided, the image will be rendered
  with a fixed aspect ratio.

  @param {image} image - The image to be rendered
  @param {string} [url] - An optional destination URL for the image
  @param {string} [class] - Optional class to be added to the image wrapper
  @param {number} [width] - The highest resolution width of the image to be rendered
  @param {number} [height] - The highest resolution height of the image to be rendered
  @param {string} [crop] - The crop position of the image
  @param {string} [loading] - Loading attribute (lazy, eager, auto)
  @param {boolean} [blur] - Enable blur effect during loading

  @example
  {% render 'image', image: product.featured_image %}
  {% render 'image', image: product.featured_image, url: product.url, loading: 'lazy' %}
  {% render 'image',
    class: 'product__image',
    image: product.featured_image,
    url: product.url,
    width: 1200,
    height: 800,
    crop: 'center',
    loading: 'lazy',
    blur: true
  %}
{% enddoc %}

{% liquid
  unless height
    assign width = width | default: image.width
  endunless

  assign loading_attr = loading | default: 'lazy'
  assign enable_blur = blur | default: true
  assign placeholder_url = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PC9zdmc+'
  assign image_url = image | image_url: width: width, height: height, crop: crop

  if url
    assign wrapper = 'a'
  else
    assign wrapper = 'div'
  endif
%}

<{{ wrapper }}
  class="image block relative overflow-hidden w-full h-auto {{ class }}"
  {% if url %}
    href="{{ url }}"
  {% endif %}
>
  {% if loading_attr == 'lazy' %}
    <img
      src="{{ placeholder_url }}"
      data-src="{{ image_url }}"
      alt="{{ image.alt | escape }}"
      width="{{ width }}"
      height="{{ height }}"
      class="w-full h-auto {% if enable_blur %}blur-sm{% endif %} transition-all duration-300"
      loading="lazy"
      onload="this.classList.remove('blur-sm')"
    >
  {% else %}
    {{ image | image_url: width: width, height: height, crop: crop | image_tag: class: 'w-full h-auto' }}
  {% endif %}
</{{ wrapper }}>
